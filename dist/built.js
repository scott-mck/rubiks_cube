!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("jquery"),require("gsap"),require("three")):"function"==typeof define&&define.amd?define(["jquery","gsap","three"],t):t(e.$,e.TweenMax,e.THREE)}(this,function(e,t,i){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t,i="default"in i?i["default"]:i;var n=new i.Scene;n.background=new i.Color(16777215);var o=new i.PerspectiveCamera,r={};r.allCubes=[];var a=function(e){r.dimensions=e,r.cubieOffset=.5,r.cubieSize=20,r.cubieDistance=r.cubieSize+r.cubieOffset,r.startPos=(r.dimensions-1)/2*(r.cubieSize+r.cubieOffset),r.scrambleLength=25+3*(r.dimensions-3),r.lineHelperWidth=5-.3*(r.dimensions-2)},s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e},l=function(){function e(){s(this,e)}return c(e,[{key:"setAnchor1",value:function(e){this.anchor1=e.position.clone()}},{key:"setAnchor2",value:function(e){this.anchor2=e.position.clone()}},{key:"init",value:function(){this._faceMap={r:{anchor:this.anchor1,shoot:["z","y"],dir:-1},u:{anchor:this.anchor1,shoot:["z","x"],dir:-1},f:{anchor:this.anchor1,shoot:["x","y"],dir:-1},l:{anchor:this.anchor2,shoot:["z","y"],dir:1},d:{anchor:this.anchor2,shoot:["z","x"],dir:1},b:{anchor:this.anchor2,shoot:["x","y"],dir:1}}}},{key:"grabFace",value:function(e){if("x"===e[0]||"y"===e[0])return n.children.filter(function(e){return"cubie"===e.name});this._face=this._faceMap[e];var t=this._face.shoot[0].toUpperCase(),o=(new i.Vector3)["set"+t](1*this._face.dir),r=this._face.shoot[1].toUpperCase(),a=(new i.Vector3)["set"+r](1),s=new i.Raycaster(this._face.anchor,o),c=this.raycast(s);return this.filterIntersects(c),this.fillOutFace(c,a),c}},{key:"getClickData",value:function(e,t){var o=new i.Vector2,r=new i.Raycaster;o.x=e/renderer.domElement.clientWidth*2-1,o.y=2*-(t/renderer.domElement.clientHeight)+1,r.setFromCamera(o,camera);var a=r.intersectObjects(n.children);if(0===a.length)return null;var s=a[0].object,c=a[0].face.normal,u=new i.Matrix4;return u=u.extractRotation(s.matrixWorld),u=u.multiplyVector3(c.clone()),{object:s,normal:this.axisFromVector(u)}}},{key:"shoot",value:function(e,t){var n=e.position.clone(),o=t.negate().clone(),r=new i.Raycaster(n,o);return this.filterIntersects(this.raycast(r))}},{key:"fillOutFace",value:function(e,t){var n=e,o=[],a=e[0].position.clone(),s=e[e.length-1].position.clone(),c=a.clone(),u=this.axisFromVector(a.sub(s));c=c["set"+u.toUpperCase()](r.startPos);var l=(new i.Vector3)["set"+u.toUpperCase()](r.cubieDistance),h=void 0,d=void 0;for(h=0;h<r.dimensions;h++)d=new i.Raycaster(c,t),o=this.raycast(d),n=n.concat(o),d=new i.Raycaster(c,t.negate()),o=this.raycast(d),n=n.concat(o),c=c.sub(l);for(this.filterIntersects(n),e.splice(0),h=0;h<n.length;h++)e.push(n[h])}},{key:"filterIntersects",value:function(e){var t=[],i=void 0,n=void 0;for(i=0;i<e.length;i++)n=e[i],"cubie"===n.name&&t.indexOf(n)===-1&&t.push(n);for(e.splice(0),i=0;i<t.length;i++)e.push(t[i]);return e}},{key:"raycast",value:function(e){return e.intersectObjects(n.children).map(function(e){return e.object})}},{key:"axisFromVector",value:function(e){return Math.abs(Math.round(e.x))>=1?"x":Math.abs(Math.round(e.y))>=1?"y":Math.abs(Math.round(e.z))>=1?"z":void 0}},{key:"vectorFromAxis",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return e=e.toUpperCase(),(new i.Vector3)["set"+e](t)}}]),e}(),h=new l,d=new i.WebGLRenderer,f=function(){function e(){s(this,e),this._rotateMap={r:{axis:"x",dir:-1},l:{axis:"x",dir:-1},u:{axis:"y",dir:-1},d:{axis:"y",dir:1},f:{axis:"z",dir:-1},b:{axis:"z",dir:1}},this._rotateMap.x=this._rotateMap.r,this._rotateMap.y=this._rotateMap.u,this._queue=[]}return c(e,[{key:"move",value:function(e){this._queue.push(e),x.go()}},{key:"nextMove",value:function(){var e=this._queue.shift();return"string"==typeof e?this._getMoveDetails(e):"function"==typeof e?e():void 0}},{key:"scramble",value:function(){var e=void 0;for(e=0;e<25;e++)this._queue.push(this.randomMove());x.go()}},{key:"randomMove",value:function(){var e=["x","y","z"],t=e.splice(~~(Math.random()*e.length),1)[0],n=h.vectorFromAxis(t,-1),o=r.startPos-r.cubieDistance*~~(Math.random()*r.dimensions),a=r.startPos-r.cubieDistance*~~(Math.random()*r.dimensions),s=new i.Vector3;s["set"+e[0].toUpperCase()](o),s["set"+e[1].toUpperCase()](a),s["set"+t.toUpperCase()](r.startPos);var c=new i.Raycaster(s,n),u=e.splice(~~(Math.random()*e.length),1)[0];return function(){var t=h.raycast(c);h.filterIntersects(t),h.fillOutFace(t,h.vectorFromAxis(u));var i=Math.random()<.5?1:-1;return{objects:t,axis:e[0],dir:i}}}},{key:"_getMoveDetails",value:function(e){var t=e[0],i=this._rotateMap[t],n=h.grabFace(t),o=i.axis,r=i.dir;return e.indexOf("Prime")>-1&&(r*=-1),{objects:n,axis:o,dir:r}}}]),e}(),v=new f,m=.1,p="linear",b=1,_=.3,y=function(){function e(){s(this,e),this._rotater=new i.Object3D,this._rotater.name="rotater",n.add(this._rotater)}return c(e,[{key:"init",value:function(){t.ticker.addEventListener("tick",this.render.bind(this))}},{key:"go",value:function(){this.animating||this._next()}},{key:"animate",value:function(e){var t=e.objects,i=e.axis,n=e.dir;this.animating||this._animate({objects:t,axis:i,dir:n})}},{key:"_animate",value:function(e){var o,r=this,a=e.objects,s=e.axis,c=e.dir;this.animating=!0;var l=void 0;for(l=0;l<a.length;l++)i.SceneUtils.attach(a[l],n,this._rotater);var h=function(){r._rotater.rotation[s]=Math.PI/2*c,r._wait(r._complete.bind(r))};t.to(this._rotater.rotation,m,(o={},u(o,s,"+="+Math.PI/2*c),u(o,"ease",p),u(o,"onComplete",h),o))}},{key:"setRotation",value:function(e,i){t.to(this._rotater.rotation,0,u({},e,"+="+i))}},{key:"_next",value:function(){var e=v.nextMove();e&&this._animate(e)}},{key:"render",value:function(){d.render(n,o)}},{key:"_complete",value:function(){var e=this;this.reset(),this._wait(function(){e.animating=!1,e._next()})}},{key:"_wait",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?b:arguments[1],i=function n(){return 0===t?void e():(t-=1,void requestAnimationFrame(n))};i()}},{key:"grip",value:function(e,t){var o=void 0;for(o=0;o<e.length;o++)i.SceneUtils.attach(e[o],n,this._rotater);this._rotatingAxis=t}},{key:"snap",value:function(){var e,i=this,n=this._rotater.rotation[this._rotatingAxis],o=n<0,r=o?-Math.PI/2:Math.PI/2,a=n%r;Math.abs(a)>Math.PI/4?a=r-a:a*=-1,t.to(this._rotater.rotation,_,(e={},u(e,this._rotatingAxis,"+="+a),u(e,"onComplete",function(){i.reset()}),e))}},{key:"reset",value:function(){for(;this._rotater.children[0];)i.SceneUtils.detach(this._rotater.children[0],this._rotater,n);this._rotater.rotation.set(0,0,0),this._rotatingAxis=null}}]),e}(),x=new y,k=function(){function e(){s(this,e),this.keyMap={i:"r",k:"rPrime",j:"u",f:"uPrime",h:"f",g:"fPrime",s:"d",l:"dPrime",e:"l",d:"lPrime",q:"b",p:"bPrime",";":"y",a:"yPrime",y:"x",n:"xPrime"}}return c(e,[{key:"getNotation",value:function(e){return this.keyMap[e]}}]),e}(),w=new k,g=.005,M=function(){function t(){s(this,t),this._normalMap={x:{horizontal:"z",vertical:"y"},y:{horizontal:"x",vertical:"z"},z:{horizontal:"x",vertical:"y"}},this._rotationMap={x:1,y:1,z:-1}}return c(t,[{key:"init",value:function(){this.$canvas=e("#canvas"),this.addEvents()}},{key:"addEvents",value:function(){e("#scramble").click(function(){v.scramble()}),e(window).on("keyup",this.type.bind(this)),this.$canvas.on("mousedown",this.mousedown.bind(this))}},{key:"mousedown",value:function(e){var t=this,i=d.domElement.getBoundingClientRect(),n=event.clientX-i.left,o=event.clientY-i.top;if(this._currentX=e.clientX,this._currentY=e.clientY,this._clickData=grabber.getClickData(n,o),!this._clickData)return void this._detectClickDirection(function(){t._rotationAxis="horizontal"===t._lockAxis?"y":"x",x.grip(r.allCubes,t._rotationAxis),t.$canvas.on("mousemove.input",t._mousemove.bind(t)),t.$canvas.one("mouseup",t._mouseup.bind(t))});var a=grabber.vectorFromAxis(this._clickData.normal);this._cubes=grabber.shoot(this._clickData.object,a),this._detectClickDirection(function(){var e=t._normalMap[t._clickData.normal][t._lockAxis].toUpperCase();t._clickData.direction=e;var i=grabber.vectorFromAxis(t._clickData.normal),n=grabber.vectorFromAxis(t._clickData.direction);t._rotationAxis=grabber.axisFromVector(i.cross(n)),grabber.fillOutFace(t._cubes,n),x.grip(t._cubes,t._rotationAxis)}),this.$canvas.on("mousemove.input",this._mousemove.bind(this)),this.$canvas.one("mouseup",this._mouseup.bind(this))}},{key:"_detectClickDirection",value:function(e){var t=this;this.$canvas.one("mousemove",function(i){var n=i.clientX-t._currentX,o=i.clientY-t._currentY;t._lockAxis=Math.abs(n)>=Math.abs(o)?"horizontal":"vertical",e&&e()})}},{key:"_mousemove",value:function(e){var t=e.clientX-this._currentX,i=e.clientY-this._currentY,n="horizontal"===this._lockAxis?t:i;n*=Math.PI/2*g,n*=this._rotationMap[this._rotationAxis],x.setRotation(this._rotationAxis,n),this._currentX=e.clientX,this._currentY=e.clientY}},{key:"_mouseup",value:function(e){x.snap(),this.$canvas.off("mousemove.input"),this._clickData=null,this._currentX=null,this._currentY=null,this._cubes=null,this._lockAxis=null,this._rotationAxis=null}},{key:"type",value:function(e){var t=String.fromCharCode(e.keyCode).toLowerCase();186===e.keyCode&&(t=";");var i=w.getNotation(t);i&&v.move(i)}}]),t}(),P=new M;window.$=e,window.TweenMax=t,window.THREE=i,window.scene=n,window.camera=o,window.grabber=h,window.renderer=d,window.animator=x,window.inputHandler=P;var z=function(){R(),O(),j(),F(),camera.position.x+=40+25*(r.dimensions-2),camera.position.y+=40+25*(r.dimensions-2),camera.position.z+=60+35*(r.dimensions-2),camera.lookAt(new i.Vector3),P.init(),h.init(),x.init()},C=void 0,A=void 0,R=function(){C=new i.MeshBasicMaterial({color:16777215,vertexColors:i.FaceColors,side:i.DoubleSide}),A=new i.BoxGeometry(r.cubieSize,r.cubieSize,r.cubieSize),A.faces[0].color.setRGB(1,0,0),A.faces[1].color.setRGB(1,0,0),A.faces[2].color.setRGB(1,.5,0),A.faces[3].color.setRGB(1,.5,0),A.faces[4].color.setRGB(1,1,0),A.faces[5].color.setRGB(1,1,0),A.faces[6].color.setRGB(1,1,1),A.faces[7].color.setRGB(1,1,1),A.faces[8].color.setRGB(0,0,1),A.faces[9].color.setRGB(0,0,1),A.faces[10].color.setRGB(0,1,0),A.faces[11].color.setRGB(0,1,0)},D=function(){var e=new i.Mesh(A.clone(),C.clone()),t=new i.EdgesHelper(e,0);return t.material.linewidth=r.lineHelperWidth,e.name="cubie",r.allCubes.push(e),n.add(e),n.add(t),e},O=function(){var e=void 0,t=void 0,i=void 0,n=void 0;for(e=0;e<2;e++)for(t=0;t<r.dimensions;t++)for(i=0;i<r.dimensions;i++){n=D(),n.position.set(r.startPos-2*e*r.startPos,r.startPos-t*(r.cubieSize+r.cubieOffset),r.startPos-i*(r.cubieSize+r.cubieOffset));var o=r.dimensions-1;0===e&&0===t&&0===i&&h.setAnchor1(n),1===e&&t===o&&i===o&&h.setAnchor2(n)}},j=function(){var e=void 0,t=void 0,i=void 0,n=void 0;for(t=0;t<2;t++)for(e=0;e<r.dimensions-2;e++)for(i=0;i<r.dimensions;i++)n=D(),n.position.set(r.startPos-(e+1)*(r.cubieSize+r.cubieOffset),r.startPos-2*t*r.startPos,r.startPos-i*(r.cubieSize+r.cubieOffset))},F=function(){var e=void 0,t=void 0,i=void 0,n=void 0;for(i=0;i<2;i++)for(t=0;t<r.dimensions-2;t++)for(e=0;e<r.dimensions-2;e++)n=D(),n.position.set(r.startPos-(e+1)*(r.cubieSize+r.cubieOffset),r.startPos-(t+1)*(r.cubieSize+r.cubieOffset),r.startPos-2*i*r.startPos)},S=.7,B=void 0,G=void 0,E=void 0,I=void 0,U=void 0,V=void 0,q=void 0,X=void 0,Y=void 0,$=void 0,H=void 0,T=void 0,W=new TimelineMax({paused:!0}),L={init:function(){B=e(window),G=e(".backdrop"),E=e(".select"),I=e(".cube-size"),U=e("#canvas"),V=e("#expand"),q=e("#sidebar"),d.setPixelRatio(devicePixelRatio),U.append(d.domElement),B.click(function(e){return e.preventDefault()}),I.click(function(t){T=parseInt(e(t.currentTarget).find(".choice").attr("id")),W.reverse()}),J(),N(),W.play(),d.render(n,o)}},N=function(){X=U.width(),Y=U.height(),$=B.width(),H=B.height(),o.aspect=X/Y,o.updateProjectionMatrix(),d.setSize(X,Y)},J=function(){W.to(E,S,{opacity:1,y:50,ease:Power3.easeOut}),W.eventCallback("onReverseComplete",function(){E.hide(),G.hide(),a(T),z()})};e(document).ready(function(){L.init()})});
